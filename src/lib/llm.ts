import OpenAI from 'openai';

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

function getOpenAI(): OpenAI {
    if (!process.env.OPENAI_API_KEY) {
        throw new Error('API_KEY_MISSING');
    }
    return openai;
}

export interface ParsedProperty {
    title: string | null;
    deal_type: 'SALE' | 'JEONSE' | 'MONTHLY' | null;
    property_type: 'APARTMENT' | 'OFFICETEL' | 'VILLA' | 'ONEROOM' | 'TWOROOM' | 'SHOP' | null;
    region: string | null;
    area_m2: number | null;
    floor: string | null;
    deposit: number | null;       // ë³´ì¦ê¸ˆ (ë§Œì›)
    monthly_rent: number | null;  // ì›”ì„¸ (ë§Œì›)
    price: number | null;         // ë§¤ë§¤ê°€ (ë§Œì›)
    options: string[];
    highlights: string | null;
}

const SYSTEM_PROMPT = `ë„ˆëŠ” ë¶€ë™ì‚° ë§¤ë¬¼ ì •ë³´ ì¶”ì¶œ ì „ë¬¸ AIë‹¤.
ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ì—ì„œ ë¶€ë™ì‚° ë§¤ë¬¼ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ ì˜¤ì§ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ë¼.
JSONì„ ê°ì‹¸ëŠ” ë§ˆí¬ë‹¤ìš´(\`\`\`json ë“±)ì´ë‚˜ ì–´ë– í•œ ë¶€ì—° ì„¤ëª…ë„ ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ˆë¼.
í…ìŠ¤íŠ¸ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì •ë³´ëŠ” ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ê³  null (ì˜µì…˜ì˜ ê²½ìš° ë¹ˆ ë°°ì—´ [])ë¡œ ì²˜ë¦¬í•´ë¼.

[í•„ìˆ˜ ì¶œë ¥ í¬ë§·]
{
  "title": "ë§¤ë¬¼ ì œëª© ë˜ëŠ” ì§§ì€ ìš”ì•½ (ì—†ìœ¼ë©´ null)",
  "deal_type": "SALE(ë§¤ë§¤), JEONSE(ì „ì„¸), MONTHLY(ì›”ì„¸) ì¤‘ ì •í™•íˆ í•˜ë‚˜ (ì—†ìœ¼ë©´ null)",
  "property_type": "APARTMENT(ì•„íŒŒíŠ¸), OFFICETEL(ì˜¤í”¼ìŠ¤í…”), VILLA(ë¹Œë¼/ì£¼íƒ), ONEROOM(ì›ë£¸), TWOROOM(íˆ¬ë£¸), SHOP(ìƒê°€) ì¤‘ ì •í™•íˆ í•˜ë‚˜ (ì—†ìœ¼ë©´ null)",
  "region": "ë™/ì/ë©´ ë‹¨ìœ„ê¹Œì§€ì˜ ì£¼ì†Œ (ì—†ìœ¼ë©´ null)",
  "area_m2": ë©´ì  ìˆ«ìë§Œ (ë‹¨ìœ„ ì—†ì´, ì—†ìœ¼ë©´ null),
  "floor": "ì¸µìˆ˜ ë¬¸ìì—´ (ì˜ˆ: 3ì¸µ, ê³ ì¸µ, ë°˜ì§€í•˜, ì—†ìœ¼ë©´ null)",
  "deposit": ë³´ì¦ê¸ˆ ë§Œì› ë‹¨ìœ„ ìˆ«ì (ì—†ìœ¼ë©´ null),
  "monthly_rent": ì›”ì„¸ ë§Œì› ë‹¨ìœ„ ìˆ«ì (ì—†ìœ¼ë©´ null),
  "price": ë§¤ë§¤ê°€ ë§Œì› ë‹¨ìœ„ ìˆ«ì (ì—†ìœ¼ë©´ null),
  "options": ["ì¶”ì¶œëœ ì˜µì…˜ ë°°ì—´, ì˜ˆ: ì—˜ë¦¬ë² ì´í„°, ì£¼ì°¨, ì—ì–´ì»¨, í’€ì˜µì…˜ ë“±"],
  "highlights": "ê°€ì¥ ê°•ì¡°ë˜ëŠ” ì¥ì  1~2ê°œ ìš”ì•½ ì§§ì€ ë¬¸ìì—´ (ì—†ìœ¼ë©´ null)"
}`;

/**
 * ìŠ¤í¬ë˜í•‘ëœ í…ìŠ¤íŠ¸ë¥¼ LLMìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ ì •í˜•í™”ëœ ë§¤ë¬¼ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 * JSON ëª¨ë“œë¥¼ ê°•ì œí•˜ì—¬ íŒŒì‹± ì—ëŸ¬ë¥¼ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
 */
export async function parsePropertyFromText(text: string): Promise<ParsedProperty> {
    const response = await getOpenAI().chat.completions.create({
        model: 'gpt-4o-mini', // ë¹„ìš© íš¨ìœ¨ì  ëª¨ë¸ (gpt-4-turbo ëŒ€ë¹„ ì•½ 20x ì €ë ´)
        response_format: { type: 'json_object' }, // JSON ëª¨ë“œ ê°•ì œ
        messages: [
            {
                role: 'system',
                content: SYSTEM_PROMPT,
            },
            {
                role: 'user',
                content: `ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ ë§¤ë¬¼ ë°ì´í„°ë¥¼ ì¶”ì¶œí•´:\n\n${text}`,
            },
        ],
        temperature: 0.1, // ë‚®ì€ ì˜¨ë„ = ì¼ê´€ì„±, í™˜ê° ê°ì†Œ
        max_tokens: 500,  // ì¶œë ¥ í† í° ì œí•œ
    });

    const content = response.choices[0]?.message?.content;
    if (!content) throw new Error('LLM ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');

    const parsed = JSON.parse(content) as ParsedProperty;

    // options ê¸°ë³¸ê°’ ë³´ì¥
    if (!Array.isArray(parsed.options)) {
        parsed.options = [];
    }

    return parsed;
}

/**
 * ì´ë¯¸ì§€(ìŠ¤í¬ë¦°ìƒ·)ì—ì„œ ë¶€ë™ì‚° ë§¤ë¬¼ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
 * GPT-4o-miniì˜ Vision ê¸°ëŠ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export async function parsePropertyFromImage(base64Image: string): Promise<ParsedProperty> {
    // data:image/... prefixê°€ ìˆìœ¼ë©´ ì œê±°
    const base64Data = base64Image.includes(',')
        ? base64Image.split(',')[1]
        : base64Image;

    const response = await getOpenAI().chat.completions.create({
        model: 'gpt-4o-mini',
        response_format: { type: 'json_object' },
        messages: [
            {
                role: 'system',
                content: SYSTEM_PROMPT,
            },
            {
                role: 'user',
                content: [
                    {
                        type: 'text',
                        text: 'ì´ ì´ë¯¸ì§€ëŠ” ë¶€ë™ì‚° ë§¤ë¬¼ í˜ì´ì§€ì˜ ìŠ¤í¬ë¦°ìƒ·ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ì—ì„œ ë³´ì´ëŠ” ë§¤ë¬¼ ì •ë³´ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.',
                    },
                    {
                        type: 'image_url',
                        image_url: {
                            url: `data:image/png;base64,${base64Data}`,
                            detail: 'high',
                        },
                    },
                ],
            },
        ],
        temperature: 0.1,
        max_tokens: 500,
    });

    const content = response.choices[0]?.message?.content;
    if (!content) throw new Error('LLM ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');

    const parsed = JSON.parse(content) as ParsedProperty;

    if (!Array.isArray(parsed.options)) {
        parsed.options = [];
    }

    return parsed;
}

export interface GeneratedContent {
    description: string;
    blogContent: string;
    smsContent: string;
    checklist: string;
}

export async function generatePropertyContent(property: ParsedProperty): Promise<GeneratedContent> {
    const dealTypeMap: Record<string, string> = {
        SALE: 'ë§¤ë§¤',
        JEONSE: 'ì „ì„¸',
        MONTHLY: 'ì›”ì„¸',
    };
    const propertyTypeMap: Record<string, string> = {
        APARTMENT: 'ì•„íŒŒíŠ¸',
        OFFICETEL: 'ì˜¤í”¼ìŠ¤í…”',
        VILLA: 'ë¹Œë¼/ì£¼íƒ',
        ONEROOM: 'ì›ë£¸',
        TWOROOM: 'íˆ¬ë£¸',
        SHOP: 'ìƒê°€',
    };

    const options = Array.isArray(property.options) ? property.options : [];

    // ê¸ˆì•¡ í¬ë§·íŒ… í•¨ìˆ˜ (ë§Œì› ë‹¨ìœ„ë¥¼ ì–µ/ë§Œ ë‹¨ìœ„ë¡œ)
    const formatPrice = (value: number | null) => {
        if (!value) return 'í™•ì¸ í•„ìš”';
        if (value >= 10000) {
            const eok = Math.floor(value / 10000);
            const man = value % 10000;
            return man === 0 ? `${eok}ì–µ` : `${eok}ì–µ ${man}ë§Œ`;
        }
        return `${value}ë§Œ`;
    };

    const priceInfo = property.deal_type === 'MONTHLY'
        ? `ë³´ì¦ê¸ˆ ${formatPrice(property.deposit)} / ì›”ì„¸ ${formatPrice(property.monthly_rent)}`
        : property.deal_type === 'JEONSE'
            ? `ì „ì„¸ ${formatPrice(property.deposit)}`
            : `ë§¤ë§¤ ${formatPrice(property.price)}`;

    const dealType = dealTypeMap[property.deal_type || ''] || 'ë¯¸í™•ì¸';
    const propertyType = propertyTypeMap[property.property_type || ''] || 'ë¯¸í™•ì¸';
    const region = property.region || 'ë¯¸í™•ì¸';
    const area = property.area_m2 ? `${property.area_m2}mÂ² (ì•½ ${Math.round(property.area_m2 * 0.3025)}í‰)` : 'ë¯¸í™•ì¸';

    const summary = `
[ë§¤ë¬¼ ê¸°ì´ˆ ì •ë³´]
- ìœ í˜•: ${propertyType}
- ê±°ë˜: ${dealType}
- ê°€ê²©: ${priceInfo}
- ìœ„ì¹˜: ${region}
- ë©´ì : ${area}
- ì¸µìˆ˜: ${property.floor || 'ë¯¸í™•ì¸'}
- ì˜µì…˜/ì‹œì„¤: ${options.length > 0 ? options.join(', ') : 'ì—†ìŒ'}
- ê°•ì¡°ì /íŠ¹ì´ì‚¬í•­: ${property.highlights || 'ì—†ìŒ'}
- ì œëª©(ì›ë¬¸): ${property.title || 'ì—†ìŒ'}
    `.trim();

    const CONTENT_GENERATION_SYSTEM_PROMPT = `ë‹¹ì‹ ì€ 10ë…„ ì´ìƒ ê²½ë ¥ì˜ ê³µì¸ì¤‘ê°œì‚¬ì´ì ë¶€ë™ì‚° ì „ë¬¸ ë§ˆì¼€í„°ì…ë‹ˆë‹¤. ì‹¤ì œ í˜„ì¥ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì˜ ê³ í’ˆì§ˆ ë§ˆì¼€íŒ… ì½˜í…ì¸ ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

[ì ˆëŒ€ ê·œì¹™]
- ì…ë ¥ ë°ì´í„°ì— ì—†ëŠ” ì •ë³´ëŠ” ì°½ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤. ëª¨ë¥´ëŠ” ë‚´ìš©ì€ "í™•ì¸ í•„ìš”"ë¡œ ì²˜ë¦¬.
- "ë¬´ì¡°ê±´", "í™•ì‹¤íˆ", "ìµœê³ ", "100%" ë“± ë‹¨ì •Â·ê³¼ì¥ í‘œí˜„ ê¸ˆì§€.
- ê°€ê²©ì€ ë°˜ë“œì‹œ ì–µ/ë§Œ ë‹¨ìœ„ ë³‘ê¸°. ë©´ì ì€ mÂ²ì™€ í‰ ë™ì‹œ í‘œê¸°.
- ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[1] description (ë‚´ë¶€ìš© ë§¤ë¬¼ ì„¤ëª… ì¹´ë“œ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì¤‘ê°œì‚¬ê°€ ë§¤ë¬¼ íŒŒì•…í•  ë•Œ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì •ë³´ ì¹´ë“œ. ì•„ë˜ í˜•ì‹ ê·¸ëŒ€ë¡œ ì‘ì„±:

ã€í•œì¤„ ìš”ì•½ã€‘
_(ê±°ë˜í˜•íƒœÂ·ìœ í˜•Â·ìœ„ì¹˜Â·ê°€ê²© í•µì‹¬ë§Œ ë‹´ì€ 1ë¬¸ì¥)_

ã€í•µì‹¬ ìŠ¤í™ã€‘
â–ª ê±°ë˜í˜•íƒœ: ...
â–ª ë§¤ë¬¼ìœ í˜•: ...
â–ª ìœ„ì¹˜: ...
â–ª ê°€ê²©: ...
â–ª ì „ìš©ë©´ì : ...
â–ª ì¸µìˆ˜: ...
â–ª ì‹œì„¤/ì˜µì…˜: ...
â–ª íŠ¹ì´ì‚¬í•­: ...

ã€ì¶”ì²œ í¬ì¸íŠ¸ã€‘
â‘  (êµ¬ì²´ì ì¸ ì¥ì  - ì…ì£¼ìÂ·íˆ¬ìì ê´€ì ì—ì„œ ê°€ì¹˜ ìˆëŠ” í¬ì¸íŠ¸)
â‘¡ (ë‘ ë²ˆì§¸ ì¥ì )
â‘¢ (ì„¸ ë²ˆì§¸ ì¥ì  - ìˆì„ ê²½ìš°ë§Œ)

ã€í™•ì¸/ì£¼ì˜ ì‚¬í•­ã€‘
âš  (ê´€ë¦¬ë¹„, ì…ì£¼ì¼, ì „ì…ì‹ ê³  ê°€ëŠ¥ ì—¬ë¶€ ë“± ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  ì‚¬í•­)
âš  (ì¶”ê°€ ì£¼ì˜ì‚¬í•­ - ìˆì„ ê²½ìš°ë§Œ)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[2] blogContent (ë„¤ì´ë²„ ë¸”ë¡œê·¸/ì¹´í˜ í™ë³´ê¸€)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìµœì í™” ë¡±í¼ ì½˜í…ì¸ . ì‹¤ì œ ê²€ìƒ‰ìê°€ í´ë¦­í•˜ê³  ì½ì„ ë§Œí•œ ìˆ˜ì¤€ìœ¼ë¡œ ì‘ì„±.

í˜•ì‹:
# {ì§€ì—­} {ìœ í˜•} {ê±°ë˜í˜•íƒœ} | {í•µì‹¬ í‚¤ì›Œë“œ} - {ë§¤ë ¥í¬ì¸íŠ¸ í•œ ë¬¸ì¥}

> **í•œì¤„ í•µì‹¬**: _(ì´ ë§¤ë¬¼ì˜ ê°€ì¥ í° ê°€ì¹˜ë¥¼ 1ë¬¸ì¥ìœ¼ë¡œ)_

---

## ğŸ“Œ ë§¤ë¬¼ ë¹ ë¥¸ ìš”ì•½
_(3~4ë¬¸ì¥. ê²€ìƒ‰ìê°€ ì´ ë§¤ë¬¼ì´ ìì‹ ì—ê²Œ ë§ëŠ”ì§€ 30ì´ˆ ë‚´ íŒë‹¨í•  ìˆ˜ ìˆê²Œ. ìœ„ì¹˜Â·ê°€ê²©Â·ë©´ì Â·íŠ¹ì§• ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ì„œ)_

---

## ğŸ” SEO ì •ë³´
- **í˜ì´ì§€ ì œëª©(Title)**: _(60ì ì´ë‚´, ì§€ì—­+ìœ í˜•+ê±°ë˜í˜•íƒœ+í•µì‹¬í‚¤ì›Œë“œ)_
- **ë©”íƒ€ ì„¤ëª…(Meta Description)**: _(120~160ì, í´ë¦­ì„ ìœ ë„í•˜ëŠ” ìš”ì•½)_
- **URL ìŠ¬ëŸ¬ê·¸**: _(ì˜ë¬¸ ì†Œë¬¸ì-í•˜ì´í”ˆ í˜•ì‹)_

---

## ğŸ  ë§¤ë¬¼ í•œëˆˆì— ë³´ê¸°
| í•­ëª© | ë‚´ìš© |
|------|------|
| ê±°ë˜í˜•íƒœ | ... |
| ë§¤ë¬¼ìœ í˜• | ... |
| ìœ„ì¹˜ | ... |
| ê°€ê²© | ... |
| ì „ìš©ë©´ì  | ... |
| ì¸µìˆ˜ | ... |
| ì‹œì„¤/ì˜µì…˜ | ... |

---

## âœ… ì´ ë§¤ë¬¼ì„ ì¶”ì²œí•˜ëŠ” ì´ìœ 
_(ê° í¬ì¸íŠ¸ë‹¹ 2~4ë¬¸ì¥. ë‹¨ìˆœ ë‚˜ì—´ ë§ê³  ì™œ ì¢‹ì€ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…)_

**1. {ì¶”ì²œ í¬ì¸íŠ¸ ì œëª©}**
...

**2. {ì¶”ì²œ í¬ì¸íŠ¸ ì œëª©}**
...

---

## ğŸš‡ ìƒí™œê¶Œ & ì ‘ê·¼ì„±
_(ì…ë ¥ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œë§Œ ì‘ì„±. ëª¨ë¥´ëŠ” ì—­Â·ì‹œì„¤ì€ ì–¸ê¸‰ ê¸ˆì§€. ì•Œ ìˆ˜ ì—†ìœ¼ë©´ "ì§ì ‘ í™•ì¸ í•„ìš”"ë¼ê³  ëª…ì‹œ)_

---

## âš ï¸ ê³„ì•½ ì „ ê¼­ í™•ì¸í•˜ì„¸ìš”
_(ê´€ë¦¬ë¹„, ì…ì£¼ì¼, ì „ì…ì‹ ê³ , í™•ì¸ì‚¬í•­ ë“± ì‹¤ì§ˆì ì¸ ì²´í¬ í¬ì¸íŠ¸)_

---

## â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)
**Q1. {ì˜ˆìƒ ì§ˆë¬¸}**
A. ...

**Q2. {ì˜ˆìƒ ì§ˆë¬¸}**
A. ...

_(ì´ 5~7ê°œ Q&A. ì‹¤ì œ ë§¤ìˆ˜/ì„ì°¨ì¸ì´ ìì£¼ í•˜ëŠ” ì§ˆë¬¸ ìœ„ì£¼)_

---

## ğŸ“ ë¬¸ì˜ ì•ˆë‚´
ìƒì„¸ ì‚¬ì§„, ë™ì˜ìƒ, ë§¤ë¬¼ ë¸Œë¦¬í”„ ìë£Œë¥¼ ìš”ì²­í•˜ì‹œë©´ ë°”ë¡œ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.
ë°©ë¬¸ ìƒë‹´ë„ ê°€ëŠ¥í•˜ë‹ˆ í¸í•˜ê²Œ ì—°ë½ ì£¼ì„¸ìš”.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[3] smsContent (ë¬¸ì/ë‹¨í†¡ ë°œì†¡ìš©)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì‹¤ì œ ê³µì¸ì¤‘ê°œì‚¬ê°€ ì¹´ì¹´ì˜¤í†¡ ë‹¨í†¡ë°©ì´ë‚˜ ë¬¸ìë¡œ ë³´ë‚´ëŠ” ìŠ¤íƒ€ì¼. ê° ë²„ì „ ì‚¬ì´ëŠ” ë°˜ë“œì‹œ "---"ë¡œ êµ¬ë¶„.

ã€ì´ˆë‹¨ë¬¸ (60~90ì)ã€‘
_(1~2ì¤„. ìœ„ì¹˜Â·ê°€ê²©Â·í•µì‹¬ 1ê°œë§Œ. ì˜ˆ: "ğŸ  ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ ì˜¤í”¼ìŠ¤í…” ì „ì„¸ 2ì–µ | í’€ì˜µì…˜Â·ì—­ì„¸ê¶Œ | ë¬¸ì˜ì£¼ì„¸ìš”")_

---

ã€í‘œì¤€ (120~200ì)ã€‘
_(3~5ì¤„. í•µì‹¬ ìŠ¤í™ + ì¥ì  1~2ê°œ + CTA. ì¤„ë°”ê¿ˆ ì ê·¹ í™œìš©)_

---

ã€ìƒì„¸ (250~400ì)ã€‘
_(6~9ì¤„. ìŠ¤í™ ì „ì²´ + ì¥ì  + ì£¼ì˜ì‚¬í•­ + CTA. ì‹¤ì œ ë‹¨í†¡ì— ì˜¬ë¦¬ëŠ” ëŠë‚Œìœ¼ë¡œ)_

â€» ëª¨ë“  ë²„ì „ ë§ˆì§€ë§‰ ì¤„: "ë¬¸ì˜ì£¼ì‹œë©´ ìƒì„¸ ì‚¬ì§„/ì˜ìƒ/ë¸Œë¦¬í”„ ë³´ë‚´ë“œë¦´ê²Œìš” ğŸ˜Š"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[4] checklist (ì½˜í…ì¸  ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ìƒì„±ëœ ì½˜í…ì¸ ì˜ í’ˆì§ˆì„ ê²€ìˆ˜í•˜ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸. ì‹¤ì œ ê°’ê³¼ ë¹„êµí•˜ì—¬ ì‘ì„±.

ã€ê°€ê²©/ìŠ¤í™ ì •í™•ì„±ã€‘
â–¡ ë§¤ë§¤ê°€/ì „ì„¸ê°€/ë³´ì¦ê¸ˆ+ì›”ì„¸ê°€ ì›ë³¸ ë°ì´í„°ì™€ ì¼ì¹˜í•˜ëŠ”ê°€? (ì›ë³¸: ${priceInfo})
â–¡ ë©´ì (mÂ²/í‰) í‘œê¸°ê°€ ì •í™•í•œê°€? (ì›ë³¸: ${area})
â–¡ ì¸µìˆ˜ í‘œê¸°ê°€ ì •í™•í•œê°€? (ì›ë³¸: ${property.floor || 'ë¯¸í™•ì¸'})
â–¡ ìœ„ì¹˜(ì‹œ/êµ¬/ë™) í‘œê¸°ê°€ ì •í™•í•œê°€? (ì›ë³¸: ${region})

ã€ì˜µì…˜/ì‹œì„¤ ì •í™•ì„±ã€‘
â–¡ ì…ë ¥ ë°ì´í„°ì— ì—†ëŠ” ì˜µì…˜ì„ ì„ì˜ë¡œ ì¶”ê°€í•˜ì§€ ì•Šì•˜ëŠ”ê°€?
â–¡ ì‹¤ì œ ì˜µì…˜ ëª©ë¡: ${options.length > 0 ? options.join(', ') : 'ì—†ìŒ'}

ã€í‘œí˜„ ì ì ˆì„±ã€‘
â–¡ "ë¬´ì¡°ê±´", "í™•ì‹¤íˆ", "ìµœê³ ", "100%" ë“± ë‹¨ì • í‘œí˜„ì´ ì—†ëŠ”ê°€?
â–¡ ì—†ëŠ” ì •ë³´ë¥¼ ì§€ì–´ë‚´ì§€ ì•Šê³  "í™•ì¸ í•„ìš”"ë¡œ ì²˜ë¦¬í–ˆëŠ”ê°€?
â–¡ ê°€ê²© ë‹¨ìœ„(ì–µ/ë§Œì›)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë³‘ê¸°í–ˆëŠ”ê°€?

ã€ì½˜í…ì¸  ì™„ì„±ë„ã€‘
â–¡ ë¸”ë¡œê·¸ ì œëª©ì´ SEO ì¹œí™”ì ì¸ê°€? (ì§€ì—­+ìœ í˜•+ê±°ë˜í˜•íƒœ í¬í•¨)
â–¡ FAQê°€ ì‹¤ì œ ì„ì°¨/ë§¤ìˆ˜ì¸ì´ ë¬»ëŠ” ë‚´ìš©ì¸ê°€?
â–¡ SMS 3ê°€ì§€ ë²„ì „ì´ ëª¨ë‘ ì‘ì„±ë˜ì—ˆëŠ”ê°€?
â–¡ ëª¨ë“  ë²„ì „ì— CTAê°€ í¬í•¨ë˜ì—ˆëŠ”ê°€?

[JSON ì‘ë‹µ êµ¬ì¡° - ì ˆëŒ€ ê·œì¹™]
âš  ì•„ë˜ 4ê°œ í‚¤ì˜ ê°’ì€ ë°˜ë“œì‹œ "ë¬¸ìì—´(string)"ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
âš  ì ˆëŒ€ë¡œ ì¤‘ì²© JSON ê°ì²´({ })ë‚˜ ë°°ì—´([ ])ì„ ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
âš  ì¤„ë°”ê¿ˆì€ ë°˜ë“œì‹œ \nìœ¼ë¡œ, íƒ­ì€ ê³µë°±ìœ¼ë¡œ í‘œí˜„í•˜ì„¸ìš”.
âš  ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(#, **, |, > ë“±)ëŠ” ê·¸ëŒ€ë¡œ ë¬¸ìì—´ ì•ˆì— í¬í•¨í•˜ì„¸ìš”.

ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:
{
  "description": "ã€í•œì¤„ ìš”ì•½ã€‘\nì—­ì‚¼ë™ ì˜¤í”¼ìŠ¤í…” ì „ì„¸ 1ì–µ 4000ë§Œì› ë§¤ë¬¼ì…ë‹ˆë‹¤.\n\nã€í•µì‹¬ ìŠ¤í™ã€‘\nâ–ª ê±°ë˜í˜•íƒœ: ì „ì„¸\nâ–ª ìœ„ì¹˜: ê²½ê¸° ì´ì²œì‹œ ê´€êµë™\nâ–ª ê°€ê²©: ì „ì„¸ 1ì–µ 4000ë§Œ\nâ–ª ì „ìš©ë©´ì : 72.85mÂ² (ì•½ 22í‰)\nâ–ª ì¸µìˆ˜: 3ì¸µ\n\nã€ì¶”ì²œ í¬ì¸íŠ¸ã€‘\nâ‘  ì´ì²œ ì‹œë‚´ ì ‘ê·¼ì„± ìš°ìˆ˜\nâ‘¡ ì—˜ë¦¬ë² ì´í„°Â·ì£¼ì°¨ ì™„ë¹„\n\nã€í™•ì¸/ì£¼ì˜ ì‚¬í•­ã€‘\nâš  ê´€ë¦¬ë¹„ ë° ì…ì£¼ ê°€ëŠ¥ì¼ í™•ì¸ í•„ìš”",
  "blogContent": "# ê²½ê¸° ì´ì²œ ì˜¤í”¼ìŠ¤í…” ì „ì„¸ | ì ‘ê·¼ì„±ê³¼ í¸ì˜ì„± ëª¨ë‘ ê°–ì¶˜ ë§¤ë¬¼\n\n> **í•œì¤„ í•µì‹¬**: ì´ì²œ ì‹œë‚´ ì ‘ê·¼ì„±ê³¼ ìƒí™œ í¸ì˜ì„±ì„ ëª¨ë‘ ê°–ì¶˜ ê´€êµë™ ì˜¤í”¼ìŠ¤í…”\n\n---\n\n## ğŸ“Œ ë§¤ë¬¼ ë¹ ë¥¸ ìš”ì•½\nê²½ê¸°ë„ ì´ì²œì‹œ ê´€êµë™ì— ìœ„ì¹˜í•œ ì˜¤í”¼ìŠ¤í…” ì „ì„¸ ë§¤ë¬¼ì…ë‹ˆë‹¤...\n\n---\n\n## ğŸ  ë§¤ë¬¼ í•œëˆˆì— ë³´ê¸°\n| í•­ëª© | ë‚´ìš© |\n|------|------|\n| ê±°ë˜í˜•íƒœ | ì „ì„¸ |\n| ê°€ê²© | 1ì–µ 4000ë§Œì› |",
  "smsContent": "ğŸ  ì´ì²œ ê´€êµë™ ì˜¤í”¼ìŠ¤í…” ì „ì„¸ 1ì–µ 4000ë§Œ | ì—˜ë² Â·ì£¼ì°¨ ì™„ë¹„ | ë¬¸ì˜ì£¼ì‹œë©´ ìƒì„¸ ì‚¬ì§„/ì˜ìƒ/ë¸Œë¦¬í”„ ë³´ë‚´ë“œë¦´ê²Œìš” ğŸ˜Š\n\n---\n\nğŸ“‹ [ì´ì²œ ì˜¤í”¼ìŠ¤í…” ì „ì„¸]\nìœ„ì¹˜: ê²½ê¸° ì´ì²œì‹œ ê´€êµë™\në©´ì : 72.85mÂ² (ì•½ 22í‰) / 3ì¸µ\nì „ì„¸: 1ì–µ 4000ë§Œì›\nì‹œì„¤: ì—˜ë¦¬ë² ì´í„°, ì£¼ì°¨\në¬¸ì˜ì£¼ì‹œë©´ ìƒì„¸ ì‚¬ì§„/ì˜ìƒ/ë¸Œë¦¬í”„ ë³´ë‚´ë“œë¦´ê²Œìš” ğŸ˜Š",
  "checklist": "ã€ê°€ê²©/ìŠ¤í™ ì •í™•ì„±ã€‘\nâ–¡ ì „ì„¸ê°€ 1ì–µ 4000ë§Œì›ì´ ì •í™•íˆ í‘œê¸°ë˜ì—ˆëŠ”ê°€?\nâ–¡ ë©´ì  72.85mÂ² (ì•½ 22í‰) í‘œê¸°ê°€ ì •í™•í•œê°€?"
}`;

    const response = await getOpenAI().chat.completions.create({
        model: 'gpt-4o',  // ê³ í’ˆì§ˆ ì½˜í…ì¸  ìƒì„±ì„ ìœ„í•´ gpt-4o ì‚¬ìš© (íŒŒì‹±ì€ mini ìœ ì§€)
        messages: [
            {
                role: 'system',
                content: CONTENT_GENERATION_SYSTEM_PROMPT,
            },
            {
                role: 'user',
                content: `ì•„ë˜ ë§¤ë¬¼ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¦‰ì‹œ í™œìš© ê°€ëŠ¥í•œ ê³ í’ˆì§ˆ ë§ˆì¼€íŒ… ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.\n\n${summary}\n\nê° ì½˜í…ì¸ ëŠ” ì‹¤ì œ í˜„ì¥ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`,
            },
        ],
        response_format: { type: 'json_object' },
        temperature: 0.65,
        max_tokens: 4000,
    });

    const body = response.choices[0]?.message?.content;
    if (!body) throw new Error('ì½˜í…ì¸  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

    console.log('[DEBUG] LLM Response Body:', body);

    const res = JSON.parse(body);

    // LLMì´ string ëŒ€ì‹  ê°ì²´ë¥¼ ë°˜í™˜í•  ê²½ìš° ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    const ensureString = (val: any): string => {
        if (typeof val === 'string') return val;
        if (val === null || val === undefined) return '';
        if (typeof val === 'object') {
            // ì¤‘ì²© ê°ì²´ë¥¼ ì„¹ì…˜ë³„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            return Object.entries(val)
                .map(([k, v]) => {
                    const content = typeof v === 'string' ? v
                        : Array.isArray(v) ? v.join('\n')
                        : typeof v === 'object' ? Object.entries(v as Record<string, unknown>).map(([k2, v2]) => `  ${k2}: ${v2}`).join('\n')
                        : String(v);
                    return `ã€${k}ã€‘\n${content}`;
                })
                .join('\n\n');
        }
        return String(val);
    };

    return {
        description: ensureString(res.description),
        blogContent: ensureString(res.blogContent),
        smsContent: ensureString(res.smsContent),
        checklist: ensureString(res.checklist || res.checkList || "ìƒì„±ëœ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
    };
}
